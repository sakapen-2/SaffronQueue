deploy_compose:
  stage: deploy
  image: alpine:3.20
  when: manual
  allow_failure: false
  variables:
    DEPLOY_IMAGE_TAG: "latest"    
  before_script:
    - apk add --no-cache openssh-client rsync bash
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - eval "$(ssh-agent -s)"
    - echo "$DEPLOY_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - ssh-keyscan -H "$DEPLOY_HOST" >> ~/.ssh/known_hosts
  script:
    - mkdir -p deploy_out
    - printf "REGISTRY_IMAGE=%s\nIMAGE_TAG=%s\n" "$CI_REGISTRY_IMAGE" "$DEPLOY_IMAGE_TAG" > deploy_out/.env

    - rsync -avz deploy/docker-compose.prod.yml deploy_out/.env "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/"

    - >
      ssh "$DEPLOY_USER@$DEPLOY_HOST" "
      set -e;
      cd '$DEPLOY_PATH';
      echo '$CI_REGISTRY_PASSWORD' | docker login -u '$CI_REGISTRY_USER' --password-stdin '$CI_REGISTRY';
      docker compose --env-file .env -f docker-compose.prod.yml pull;
      docker compose --env-file .env -f docker-compose.prod.yml up -d;
      docker image prune -f;
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == "cd"'
      when: manual
